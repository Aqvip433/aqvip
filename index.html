<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #F0F2F5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    textarea {
      width: 90%;
      max-width: 700px;
      min-height: 300px;
      height: 300px;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      resize: vertical;
      overflow-y: auto;
      transition: height 0.2s;
    }
    button {
      background: #000;
      color: #fff;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background: #444;
    }
    #preview {
      display: none !important;
      visibility: hidden;
      height: 0;
      width: 0;
      overflow: hidden;
    }
    #preview img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: box-shadow 0.3s;
    }
    .download-btn {
      margin-top: 24px;
    }
    a {
      margin-top: 12px;
      text-decoration: none;
      font-size: 14px;
      color: #007AFF;
    }
    /* Lightbox styles */
    #lightbox {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
    }
    #lightbox img {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .centered {
      text-align: center;
    }
    .choose-title {
      margin-bottom: 16px;
    }
    .style-options {
      display: flex;
      justify-content: center;
    }
    .style-label {
      margin: 0 10px;
    }
    .style-preview {
      width: 120px;
      height: 80px;
      border-radius: 12px;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .radio-circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #fff;
      border: 2px solid #000;
      margin-top: 10px;
    }
    .choose-btn {
      margin-top: 20px;
    }
    .back-btn {
      margin-bottom: 20px;
    }
    .style-lightbox {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
    }
    #lightboxCanvas {
      width: 400px;
      height: 260px;
    }
    #historyList {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 28px;
      margin-top: 18px;
      margin-bottom: 32px;
      width: 100%;
      max-width: 1100px;
      justify-content: center;
    }
    .history-block {
      background: rgba(255,255,255,0.90);
      border-radius: 28px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      padding: 0;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 220px;
      min-width: 0;
      transition: box-shadow 0.2s;
    }
    .history-block:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.13);
    }
    .history-img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: #f8f9fa;
      cursor: pointer;
      border-bottom: 1px solid #e5e5ea;
      display: block;
    }
    .download-icon {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.92);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      z-index: 2;
      transition: background 0.2s;
    }
    .download-icon:hover {
      background: #f0f2f5;
    }
    @media (max-width: 1100px) {
      #historyList {
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
      }
      .history-block {
        min-height: 180px;
      }
      .history-img {
        height: 140px;
      }
    }
    @media (max-width: 800px) {
      #historyList {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .history-block {
        min-height: 140px;
      }
      .history-img {
        height: 100px;
      }
    }
    @media (max-width: 500px) {
      #historyList {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .history-block {
        min-height: 110px;
      }
      .history-img {
        height: 70px;
      }
    }
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="styleSelector" class="centered">
    <h2 class="choose-title">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω —Ç–∞–±–ª–∏—Ü—ã</h2>
    <div class="style-options">
      <label class="style-label">
        <div class="style-preview style1" onclick="openStyleLightbox(1)">
          <canvas id="preview1" width="120" height="80"></canvas>
        </div>
        <input type="radio" name="tableStyle" value="style1" checked>
      </label>
      <label class="style-label">
        <div class="style-preview style2" onclick="openStyleLightbox(2)">
          <canvas id="preview2" width="120" height="80"></canvas>
        </div>
        <input type="radio" name="tableStyle" value="style2">
      </label>
      <label class="style-label">
        <div class="style-preview style3" onclick="openStyleLightbox(3)">
          <canvas id="preview3" width="120" height="80"></canvas>
        </div>
        <input type="radio" name="tableStyle" value="style3">
      </label>
      <label class="style-label">
        <div class="style-preview style4" onclick="openStyleLightbox(4)">
          <canvas id="preview4" width="120" height="80"></canvas>
        </div>
        <input type="radio" name="tableStyle" value="style4">
      </label>
    </div>
    <button id="chooseStyleBtn" class="choose-btn">–í—ã–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å</button>
  </div>
  <div id="styleLightbox" class="style-lightbox" onclick="closeStyleLightbox(event)">
    <canvas id="lightboxCanvas" width="400" height="260"></canvas>
  </div>
  <div id="mainInput" class="centered" style="display:none;">
    <button id="backToStyleBtn" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Å—Ç–∏–ª—è</button>
    <textarea id="inputText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...">üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã 24/–ò–ü-191–∫
–°–≤–µ—Ä—è–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –≥—É–≥–ª —Ç–∞–±–ª–∏—Ü–µ–π! –ó–¥–µ—Å—å –≤–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏. –í —Å–ª—É—á–∞–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π, —Å–æ–æ–±—â–∏—Ç–µ –Ω–∞–º!


‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 –°–£–ë–ë–û–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1Ô∏è‚É£ –≠–ö–ó–ê–ú–ï–ù
–§–∏–∑–∏–∫–∞ 
9.00
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –®–º–∞—Ç–∫–æ–≤
–ö–∞–±–∏–Ω–µ—Ç: 417</textarea>
    <div class="input-btns-row">
      <button onclick="generateImage()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    </div>
    <div id="preview">
      <img id="outputImg" src="">
      <button id="downloadButton" class="download-btn" style="display: none;">–°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
    </div>
    <div id="historyTitle" style="text-align:left; font-size:20px; font-weight:500; margin:32px 0 0 0; max-width:1100px;">–°–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π:</div>
    <div id="historyList"></div>
  </div>
  <div id="lightbox" onclick="closeLightbox(event)">
    <img id="lightboxImg" src="">
  </div>
  <script src="script.js"></script>
  <script>
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        for (let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = context.measureText(testLine);
            const testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {
                context.fillText(line.trim(), x, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        context.fillText(line.trim(), x, y);
        return y + lineHeight;
    }

    function estimateCallScheduleHeight(data, colWidth) {
      // Estimate height needed for the call schedule column
      let h = 0;
      const padding = 20;
      const titleH = 35 + 12;
      const pairH = 25 + 20 * 2; // name + 2 times (avg)
      const lunchH = 25 + 20 * 2;
      // Weekday schedule
      h += titleH + data.weekday_schedule.pairs.length * pairH;
      h += titleH + data.weekday_lunch.times.length * 20;
      h += 15; // separator
      h += titleH + data.saturday_schedule.pairs.length * pairH;
      h += titleH + data.saturday_lunch.times.length * 20;
      h += 40; // some margin
      return h;
    }

    function parseScheduleText(text) {
      const scheduleData = {};
      const daysInRussian = ["–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", "–í–¢–û–†–ù–ò–ö", "–°–†–ï–î–ê", "–ß–ï–¢–í–ï–†–ì", "–ü–Ø–¢–ù–ò–¶–ê", "–°–£–ë–ë–û–¢–ê"];
      const dayOrder = { "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö": 1, "–í–¢–û–†–ù–ò–ö": 2, "–°–†–ï–î–ê": 3, "–ß–ï–¢–í–ï–†–ì": 4, "–ü–Ø–¢–ù–ò–¶–ê": 5, "–°–£–ë–ë–û–¢–ê": 6 };
      const dayBlocks = text.split(new RegExp(`(?=(${daysInRussian.join('|')}))`, 'g'));
      const lessonEmojiMap = {
          '1Ô∏è‚É£': '1', '2Ô∏è‚É£': '2', '3Ô∏è‚É£': '3', '4Ô∏è‚É£': '4', '5Ô∏è‚É£': '5',
          '6Ô∏è‚É£': '6', '7Ô∏è‚É£': '7', '8Ô∏è‚É£': '8', '9Ô∏è‚É£': '9'
      };
      const lessonRegex = new RegExp(`(${Object.keys(lessonEmojiMap).join('|')})\\s*(.*)`);
      for (const block of dayBlocks) {
          if (block.trim() === "") continue;
          const lines = block.trim().split('\n');
          const day = lines[0].trim();
          if (!daysInRussian.includes(day)) continue;
          scheduleData[day] = {};
          let currentLesson = null;
          let lessonInfo = {};
          for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line === "" || line.startsWith('‚ïê')) continue;
              const lessonMatch = line.match(lessonRegex);
              if (lessonMatch) {
                  if (currentLesson) {
                      scheduleData[day][currentLesson] = lessonInfo;
                  }
                  currentLesson = lessonEmojiMap[lessonMatch[1]];
                  const subjectText = lessonMatch[2].replace('/', '').trim();
                  lessonInfo = { subject: subjectText ? [subjectText] : [] };
              } else if (currentLesson) {
                  if (line.startsWith("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:")) {
                      lessonInfo.teacher = line.replace("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:", "").trim();
                  } else if (line.startsWith("–ö–∞–±–∏–Ω–µ—Ç:")) {
                      lessonInfo.cabinet = line.replace("–ö–∞–±–∏–Ω–µ—Ç:", "").trim();
                  } else if (lessonInfo.subject && line) {
                      lessonInfo.subject.push(line);
                  }
              }
          }
          if (currentLesson) {
              scheduleData[day][currentLesson] = lessonInfo;
          }
      }
      const sortedScheduleData = Object.keys(scheduleData)
        .sort((a, b) => dayOrder[a] - dayOrder[b])
        .reduce((obj, key) => { 
          obj[key] = scheduleData[key]; 
          return obj;
        }, {});
      return sortedScheduleData;
    }

    function drawScheduleGrid(ctx, canvas, scheduleData, callScheduleData, canvasHeight, style) {
        const daysInSchedule = Object.keys(scheduleData);
        const dayDisplayNames = {
            "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í–¢–û–†–ù–ò–ö": "–í—Ç–æ—Ä–Ω–∏–∫", "–°–†–ï–î–ê": "–°—Ä–µ–¥–∞",
            "–ß–ï–¢–í–ï–†–ì": "–ß–µ—Ç–≤–µ—Ä–≥", "–ü–Ø–¢–ù–ò–¶–ê": "–ü—è—Ç–Ω–∏—Ü–∞", "–°–£–ë–ë–û–¢–ê": "–°—É–±–±–æ—Ç–∞"
        };
        const romanNumerals = ["I", "II", "III", "IV", "V", "VI"];
        const lessonNumColWidth = 60;
        const dayColWidth = 210;
        const headerHeight = 70;
        const cellPadding = 15;
        const lineHeight = 22;
        const callScheduleColWidth = 300;
        canvas.width = lessonNumColWidth + daysInSchedule.length * dayColWidth + callScheduleColWidth;
        canvas.height = canvasHeight;
        const lessonRowHeight = (canvas.height - headerHeight) / 6;
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#212529";
        ctx.font = "22px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        daysInSchedule.forEach((dayKey, index) => {
            const x = lessonNumColWidth + index * dayColWidth + dayColWidth / 2;
            ctx.fillText(dayDisplayNames[dayKey] || dayKey, x, headerHeight / 2);
        });
        ctx.font = "22px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
        romanNumerals.forEach((num, index) => {
            const y = headerHeight + index * lessonRowHeight + lessonRowHeight / 2;
            ctx.fillText(num, lessonNumColWidth / 2, y);
        });
        ctx.textAlign = "center";
        daysInSchedule.forEach((dayKey, dayIndex) => {
            const daySchedule = scheduleData[dayKey];
            if (!daySchedule) return;
            for (let lessonNum = 1; lessonNum <= 6; lessonNum++) {
                const lessonInfo = daySchedule[String(lessonNum)];
                if (!lessonInfo) continue;
                const rowIndex = lessonNum - 1;
                const x = lessonNumColWidth + dayIndex * dayColWidth + dayColWidth / 2;
                let y = headerHeight + rowIndex * lessonRowHeight + cellPadding + 10;
                const availableWidth = dayColWidth - (cellPadding * 2);
                ctx.fillStyle = "#212529";
                if (lessonInfo.subject && lessonInfo.subject.length > 0){
                    ctx.font = "bold 18px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
                    const subjectText = lessonInfo.subject.join(' ');
                    y = wrapText(ctx, subjectText, x, y, availableWidth, lineHeight);
                }
                ctx.font = "18px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
                if (lessonInfo.teacher) {
                    ctx.fillText(lessonInfo.teacher, x, y, availableWidth);
                    y += lineHeight;
                }
                if (lessonInfo.cabinet) {
                    ctx.fillText(lessonInfo.cabinet, x, y, availableWidth);
                }
            }
        });
        // --- Draw Call Schedule Column ---
        const scheduleX = lessonNumColWidth + daysInSchedule.length * dayColWidth;
        drawCallSchedule(ctx, scheduleX, canvas.height, callScheduleColWidth, callScheduleData);
        ctx.strokeStyle = "#E9ECEF";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(lessonNumColWidth, 0);
        ctx.lineTo(lessonNumColWidth, canvas.height);
        daysInSchedule.forEach((_, i) => {
            const x = lessonNumColWidth + (i + 1) * dayColWidth;
            if (x < canvas.width) {
               ctx.moveTo(x, 0);
               ctx.lineTo(x, canvas.height);
            }
        });
        ctx.moveTo(scheduleX, 0);
        ctx.lineTo(scheduleX, canvas.height);
        for (let i = 0; i <= 6; i++) {
            const y = headerHeight + i * lessonRowHeight;
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();
        ctx.strokeRect(0, 0, canvas.width, canvas.height); // Outer border
    }

    function drawCallSchedule(ctx, x, height, colWidth, data) {
        ctx.fillStyle = "#212529";
        ctx.textAlign = "left";
        const padding = 20;
        let currentY = 0;
        const drawSection = (sectionData, isPairSection) => {
            if (!sectionData) return;
            currentY += 35;
            ctx.font = "bold 18px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
            const titleText = `${sectionData.icon} ${sectionData.title}`;
            ctx.fillText(titleText, x + padding, currentY);
            currentY += 12;
            ctx.font = "16px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
            const items = isPairSection ? sectionData.pairs : [{ times: sectionData.times }];
            items.forEach(item => {
                currentY += 25;
                if (item.name) {
                    ctx.fillText(item.name, x + padding, currentY);
                }
                item.times.forEach(time => {
                    if(!item.name) {
                         currentY += 5;
                         ctx.fillText(time, x + padding, currentY);
                    } else {
                        ctx.textAlign = "right";
                        ctx.fillText(time, x + colWidth - padding, currentY);
                        ctx.textAlign = "left";
                    }
                    currentY += 20;
                });
            });
        };
        drawSection(data.weekday_schedule, true);
        drawSection(data.weekday_lunch, false);
        currentY += 15;
        ctx.beginPath();
        ctx.moveTo(x + padding, currentY);
        ctx.lineTo(x + colWidth - padding, currentY);
        ctx.strokeStyle = "#E9ECEF";
        ctx.lineWidth = 1;
        ctx.stroke();
        drawSection(data.saturday_schedule, true);
        drawSection(data.saturday_lunch, false);
    }
    // Lightbox logic
    function openLightbox(imgUrl) {
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightboxImg');
      lightboxImg.src = imgUrl;
      lightbox.style.display = 'flex';
    }
    function closeLightbox(event) {
      if (event.target.id === 'lightbox' || event.target.id === 'lightboxImg') {
        document.getElementById('lightbox').style.display = 'none';
      }
    }
    // --- –ò—Å—Ç–æ—Ä–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
    const historyList = document.getElementById('historyList');
    const historyTitle = document.getElementById('historyTitle');
    let historyImages = [];
    function addToHistory(imgUrl) {
      historyImages.unshift(imgUrl);
      renderHistory();
    }
    function renderHistory() {
      historyList.innerHTML = '';
      historyImages.forEach((imgUrl, idx) => {
        const block = document.createElement('div');
        block.className = 'history-block';
        // –ú–∏–Ω–∏–∞—Ç—é—Ä–∞
        const img = document.createElement('img');
        img.className = 'history-img';
        img.src = imgUrl;
        img.alt = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';
        img.onclick = () => openLightbox(imgUrl);
        block.appendChild(img);
        // –ö–Ω–æ–ø–∫–∞-–∏–∫–æ–Ω–∫–∞ —Å–∫–∞—á–∞—Ç—å
        const downloadBtn = document.createElement('div');
        downloadBtn.className = 'download-icon';
        downloadBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 3V15M10 15L5 10M10 15L15 10" stroke="#222" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        downloadBtn.onclick = (e) => {
          e.stopPropagation();
          const a = document.createElement('a');
          a.href = imgUrl;
          a.download = 'schedule.png';
          a.click();
        };
        block.appendChild(downloadBtn);
        historyList.appendChild(block);
      });
      // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è
      historyTitle.style.display = historyImages.length ? 'block' : 'none';
    }
    // --- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ---
    const origGenerateImage = window.generateImage;
    window.generateImage = async function() {
      await origGenerateImage();
      const imgUrl = document.getElementById('outputImg').src;
      if (imgUrl && imgUrl.startsWith('data:image')) {
        addToHistory(imgUrl);
      }
    };
  </script>
</body>
</html>
